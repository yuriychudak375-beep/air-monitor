<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Monitor</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<style>
  body {
    margin: 0;
    background: #0d0d0d; /* —Ç–µ–º–Ω–∏–π —Ñ–æ–Ω */
  }

  #map {
    width: 100vw;
    height: 100vh;
    filter: brightness(1.1); /* —Ç—Ä–æ—Ö–∏ –ø—ñ–¥—Å–≤—ñ—Ç–∏—Ç–∏ —Ç–µ–º–Ω—É –∫–∞—Ä—Ç—É */
  }
</style>

</head>
<body>
  <button id="themeToggle">üåô –¢–µ–º–Ω–∞ —Ç–µ–º–∞</button>
  <div id="map"></div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>

const map = L.map("map").setView([49,31],6);
L.tileLayer(
  "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
  {
    attribution:
      '&copy; <a href="https://carto.com/">CARTO</a> | Dark Matter tiles',
    subdomains: "abcd",
    maxZoom: 19
  }
).addTo(map);

const ICONS = {
    x101: "models/x101.png",
    shahed: "models/shahed.png",
    iskander: "models/iskander.png",
    kalibr: "models/kalibr.png"
};

// –Ü–ù–î–ò–í–Ü–î–£–ê–õ–¨–ù–Ü OFFSET
const OFFSET = {
    x101: -45,       // –ø—Ä–∞–≤–∏–ª—å–Ω–∞
    shahed: 0,   // –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ –∑ ‚Üë –Ω–∞ ‚Üí
    iskander: 0, // –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ –∑ ‚Üë –Ω–∞ ‚Üí
    kalibr: 0    // –ü–û–¢–†–Ü–ë–ù–û –ü–Ü–°–õ–Ø –¢–û–ì–û –Ø–ö –¢–ò –ö–ò–ù–ï–® PNG
};

function createMarker(lat, lon, url){
    const div = document.createElement("div");
    div.style.width="60px";
    div.style.height="60px";

    const img=document.createElement("img");
    img.src=url;
    img.style.width="100%";
    img.style.height="100%";
    img.style.transformOrigin="center";

    div.appendChild(img);

    const icon=L.divIcon({className:"",html:div,iconSize:[60,60],iconAnchor:[30,30]});

    const m=L.marker([lat,lon],{icon});
    m._img = img;
    return m;
}

const markers = new Map();

function update(list){
    const exist=new Set();

    for(const t of list){
        exist.add(t.id);

        let m = markers.get(t.id);
        if (!m){
            m = createMarker(t.lat,t.lon,ICONS[t.type]);
            m.addTo(map);
            markers.set(t.id,m);
        } else {
            m.setLatLng([t.lat,t.lon]);
        }

        // –ü–†–ê–í–ò–õ–¨–ù–ê –ú–ê–¢–ï–ú–ê–¢–ò–ö–ê
        let angle = Math.atan2(t.dy, t.dx) * 180 / Math.PI;
        angle = 90 - angle + (OFFSET[t.type] || 0);

        m._img.style.transform = `rotate(${angle}deg)`;
    }

    markers.forEach((m,id)=>{
        if (!exist.has(id)){
            map.removeLayer(m);
            markers.delete(id);
        }
    });
}

const ws = new WebSocket(`wss://${location.host}`);
ws.onmessage = e =>{
    const d = JSON.parse(e.data);
    if (d.type==="state") update(d.targets);
};
    
const THEME_KEY = "airmon_theme";
  const themeBtn = document.getElementById("themeToggle");

  function applyTheme(theme) {
    document.body.classList.remove("theme-dark", "theme-light");
    document.body.classList.add(theme);

    if (theme === "theme-dark") {
      themeBtn.textContent = "‚òÄÔ∏è –°–≤—ñ—Ç–ª–∞ —Ç–µ–º–∞";
    } else {
      themeBtn.textContent = "üåô –¢–µ–º–Ω–∞ —Ç–µ–º–∞";
    }

    try {
      localStorage.setItem(THEME_KEY, theme);
    } catch (e) {}
  }

  // —Å—Ç–∞—Ä—Ç–æ–≤–∞ —Ç–µ–º–∞
  (function initTheme() {
    let saved = null;
    try {
      saved = localStorage.getItem(THEME_KEY);
    } catch (e) {}

    if (saved !== "theme-dark" && saved !== "theme-light") {
      saved = "theme-dark"; // –¥–µ—Ñ–æ–ª—Ç
    }
    applyTheme(saved);
  })();

  themeBtn.addEventListener("click", () => {
    const current = document.body.classList.contains("theme-dark")
      ? "theme-dark"
      : "theme-light";
    const next = current === "theme-dark" ? "theme-light" : "theme-dark";
    applyTheme(next);
  });
</script>

</body>
</html>




