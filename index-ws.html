<!DOCTYPE html>
<html>
<head>
  <script src="https://unpkg.com/leaflet-geojson-vt@1.0.1/dist/leaflet-geojson-vt.js"></script>
<meta charset="utf-8">
<title>Monitor</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<style>
  body {
    margin: 0;
    background: #0d0d0d; /* —Ç–µ–º–Ω–∏–π —Ñ–æ–Ω */
  }

  #map {
    width: 100vw;
    height: 100vh;
    filter: brightness(1.1); /* —Ç—Ä–æ—Ö–∏ –ø—ñ–¥—Å–≤—ñ—Ç–∏—Ç–∏ —Ç–µ–º–Ω—É –∫–∞—Ä—Ç—É */
  }
  #themeToggle {
  position: fixed;
  top: 10px;
  right: 10px;
  z-index: 9999;
  padding: 8px 14px;
  background: rgba(20,20,20,0.85);
  color: #eee;
  border: 1px solid #555;
  border-radius: 8px;
  cursor: pointer;
  backdrop-filter: blur(6px);
  font-size: 14px;
}

body.light #themeToggle {
  background: rgba(255,255,255,0.9);
  color: #111;
  border: 1px solid #ccc;
}
#clockBox {
  position: absolute;
  top: 10px;
  left: 10px;
  z-index: 9999;
  background: rgba(0,0,0,0.55);
  padding: 8px 14px;
  border-radius: 8px;
  color: #fff;
  font-family: Arial, sans-serif;
  font-size: 16px;
  backdrop-filter: blur(4px);
  user-select: none;
  pointer-events: none;
}

</style>

</head>
<body>
  <div id="clockBox"></div>
  <button id="themeToggle">üåô –¢–µ–º–Ω–∞ —Ç–µ–º–∞</button>
  <div id="map"></div>
</body>


<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>

const map = L.map("map").setView([49,31],6);
L.tileLayer(
  "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
  {
    attribution:
      '&copy; <a href="https://carto.com/">CARTO</a> | Dark Matter tiles',
    subdomains: "abcd",
    maxZoom: 19
  }
).addTo(map);
  
function updateClock() {
    const box = document.getElementById("clockBox");
    const now = new Date();

    const dateStr = now.toLocaleDateString("uk-UA", {
      year: "numeric",
      month: "long",
      day: "numeric"
    });

    const timeStr = now.toLocaleTimeString("uk-UA", {
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit"
    });

    box.textContent = `${dateStr} ‚Äî ${timeStr}`;
  }

  setInterval(updateClock, 1000);
  updateClock();
  
const ICONS = {
    x101: "models/x101.png",
    shahed: "models/shahed.png",
    iskander: "models/iskander.png",
    kalibr: "models/kalibr.png"
};

// –Ü–ù–î–ò–í–Ü–î–£–ê–õ–¨–ù–Ü OFFSET
const OFFSET = {
    x101: -45,       // –ø—Ä–∞–≤–∏–ª—å–Ω–∞
    shahed: 0,   // –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ –∑ ‚Üë –Ω–∞ ‚Üí
    iskander: 0, // –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ –∑ ‚Üë –Ω–∞ ‚Üí
    kalibr: 0    // –ü–û–¢–†–Ü–ë–ù–û –ü–Ü–°–õ–Ø –¢–û–ì–û –Ø–ö –¢–ò –ö–ò–ù–ï–® PNG
};

function createMarker(lat, lon, url){
    const div = document.createElement("div");
    div.style.width="60px";
    div.style.height="60px";

    const img=document.createElement("img");
    img.src=url;
    img.style.width="100%";
    img.style.height="100%";
    img.style.transformOrigin="center";

    div.appendChild(img);

    const icon=L.divIcon({className:"",html:div,iconSize:[60,60],iconAnchor:[30,30]});

    const m=L.marker([lat,lon],{icon});
    m._img = img;
    return m;
}

const markers = new Map();

function update(list){
    const exist=new Set();

    for(const t of list){
        exist.add(t.id);

        let m = markers.get(t.id);
        if (!m){
            m = createMarker(t.lat,t.lon,ICONS[t.type]);
            m.addTo(map);
            markers.set(t.id,m);
        } else {
            m.setLatLng([t.lat,t.lon]);
        }

        // –ü–†–ê–í–ò–õ–¨–ù–ê –ú–ê–¢–ï–ú–ê–¢–ò–ö–ê
        let angle = Math.atan2(t.dy, t.dx) * 180 / Math.PI;
        angle = 90 - angle + (OFFSET[t.type] || 0);

        m._img.style.transform = `rotate(${angle}deg)`;
    }

    markers.forEach((m,id)=>{
        if (!exist.has(id)){
            map.removeLayer(m);
            markers.delete(id);
        }
    });
}

const ws = new WebSocket(`wss://${location.host}`);
ws.onmessage = e =>{
    const d = JSON.parse(e.data);
    if (d.type==="state") update(d.targets);
    if (data.type === "alerts") {
       applyAlerts(data.regions);
}

};

  function applyAlerts(activeRegions) {
  if (!oblastLayer) return;

  oblastLayer.eachLayer(layer => {
    const name = layer.feature.properties.name.toLowerCase();

    if (activeRegions.includes(name)) {
      layer.setStyle({
        fillColor: "red",
        fillOpacity: 0.6,
        color: "red",
        weight: 2
      });
    } else {
      layer.setStyle({
        fillColor: "#222",
        fillOpacity: 0.2,
        color: "#555",
        weight: 1
      });
    }
  });
}

const themeBtn = document.getElementById("themeToggle");

  // –¥–≤–∞ –≤–∞—Ä—ñ–∞–Ω—Ç–∏ —Ç–∞–π–ª—ñ–≤
  const LIGHT_TILE = L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png");
  const DARK_TILE = L.tileLayer(
    "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
    { subdomains: "abcd", maxZoom: 19 }
  );

  // –ü–æ—Ç–æ—á–Ω–∞ —Ç–µ–º–∞
  let currentTheme = localStorage.getItem("viewerTheme") || "dark";

  // –ü—ñ–¥–∫–ª—é—á–∞—î–º–æ —Ç–∞–π–ª –∑–∞ —Ç–µ–º–æ—é
  function applyTheme(theme) {
    if (theme === "light") {
      map.removeLayer(DARK_TILE);
      LIGHT_TILE.addTo(map);
      themeBtn.textContent = "üåô –¢–µ–º–Ω–∞ —Ç–µ–º–∞";
      document.body.classList.add("light");
    } else {
      map.removeLayer(LIGHT_TILE);
      DARK_TILE.addTo(map);
      themeBtn.textContent = "‚òÄÔ∏è –°–≤—ñ—Ç–ª–∞ —Ç–µ–º–∞";
      document.body.classList.remove("light");
    }
    localStorage.setItem("viewerTheme", theme);
    currentTheme = theme;
  }

  // –ü–æ—á–∞—Ç–∫–æ–≤–µ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è
  applyTheme(currentTheme);

  // –û–±—Ä–æ–±–Ω–∏–∫ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è
  themeBtn.onclick = () => {
    applyTheme(currentTheme === "dark" ? "light" : "dark");
  };
</script>

</body>
</html>







