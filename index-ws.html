<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Monitor</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <style>
    body{
      margin:0;
      background:#111;
      overflow:hidden;
      font-family:sans-serif;
    }
    #map{
      position:absolute;
      top:0;left:0;
      width:100vw;
      height:100vh;
      z-index:1;
    }
    #hud{
      position:absolute;
      top:10px;
      left:10px;
      z-index:2;
      display:flex;
      gap:10px;
      align-items:center;
    }
    #datetime{
      padding:6px 10px;
      background:rgba(0,0,0,0.6);
      color:#fff;
      border-radius:4px;
      font-size:13px;
    }
    #themeToggle{
      padding:6px 10px;
      background:rgba(0,0,0,0.6);
      color:#fff;
      border-radius:4px;
      border:1px solid #555;
      cursor:pointer;
      font-size:13px;
    }
  </style>
</head>
<body>

<div id="map"></div>

<div id="hud">
  <div id="datetime"></div>
  <button id="themeToggle">Світла тема</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// ===== КАРТА =====
const map = L.map("map").setView([49,31],6);

const lightLayer = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom:19,
  attribution:"&copy; OpenStreetMap"
});

const darkLayer = L.tileLayer(
  "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
  {
    maxZoom:19,
    attribution:"&copy; CartoDB & OpenStreetMap"
  }
);

// стартуємо з темної
let currentBase = darkLayer;
darkLayer.addTo(map);

const themeBtn = document.getElementById("themeToggle");
themeBtn.onclick = () => {
  if (currentBase === darkLayer) {
    map.removeLayer(darkLayer);
    lightLayer.addTo(map);
    currentBase = lightLayer;
    themeBtn.textContent = "Темна тема";
  } else {
    map.removeLayer(lightLayer);
    darkLayer.addTo(map);
    currentBase = darkLayer;
    themeBtn.textContent = "Світла тема";
  }
};

// ===== ДАТА/ЧАС =====
const dtDiv = document.getElementById("datetime");
function updateTime(){
  const now = new Date();
  const date = now.toLocaleDateString("uk-UA");
  const time = now.toLocaleTimeString("uk-UA", {hour:"2-digit",minute:"2-digit",second:"2-digit"});
  dtDiv.textContent = date + " " + time;
}
setInterval(updateTime,1000);
updateTime();

// ===== РАКЕТИ / ДРОНИ =====
const ICONS = {
  x101: "models/x101.png",
  shahed: "models/shahed.png",
  iskander: "models/iskander.png",
  kalibr: "models/kalibr.png"
};

// індивідуальні офсети, як у тебе було
const OFFSET = {
  x101: -45,
  shahed: 0,
  iskander: 0,
  kalibr: 0
};

function createMarker(lat, lon, url){
  const div = document.createElement("div");
  div.style.width="60px";
  div.style.height="60px";

  const img=document.createElement("img");
  img.src=url;
  img.style.width="100%";
  img.style.height="100%";
  img.style.transformOrigin="center";

  div.appendChild(img);

  const icon=L.divIcon({className:"",html:div,iconSize:[60,60],iconAnchor:[30,30]});

  const m=L.marker([lat,lon],{icon});
  m._img = img;
  return m;
}

const markers = new Map();

function update(list){
  const exist=new Set();

  for(const t of list){
    exist.add(t.id);

    let m = markers.get(t.id);
    if (!m){
      m = createMarker(t.lat,t.lon,ICONS[t.type]);
      m.addTo(map);
      markers.set(t.id,m);
    } else {
      m.setLatLng([t.lat,t.lon]);
    }

    // твоя "правильна математика"
    let angle = Math.atan2(t.dy, t.dx) * 180 / Math.PI;
    angle = 90 - angle + (OFFSET[t.type] || 0);

    m._img.style.transform = `rotate(${angle}deg)`;
  }

  markers.forEach((m,id)=>{
    if (!exist.has(id)){
      map.removeLayer(m);
      markers.delete(id);
    }
  });
}

const ws = new WebSocket(`wss://${location.host}`);
ws.onmessage = e =>{
  const d = JSON.parse(e.data);
  if (d.type==="state") update(d.targets || []);
};
</script>

</body>
</html>
