<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Monitor</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<style>
  :root {
    --bg-color: #0d0d0f;
    --text-color: #e1e1e7;
    --map-filter: brightness(0.85) contrast(1.05) saturate(1.05);
  }

  body {
    margin: 0;
    background: var(--bg-color);
    color: var(--text-color);
    font-family: "Inter", Arial, sans-serif;
  }

  /* Ð¢ÐµÐ¼Ð½Ð° Ñ‚ÐµÐ¼Ð° */
  body.theme-dark {
    --bg-color: #0d0d0f;
    --text-color: #e1e1e7;
    --map-filter: brightness(0.85) contrast(1.05) saturate(1.05);
  }

  /* Ð¡Ð²Ñ–Ñ‚Ð»Ð° Ñ‚ÐµÐ¼Ð° */
  body.theme-light {
    --bg-color: #f2f2f5;
    --text-color: #111111;
    --map-filter: brightness(1) contrast(1) saturate(1);
  }

  #map {
    width: 100vw;
    height: 100vh;
    filter: var(--map-filter);
  }

  #themeToggle {
    position: fixed;
    top: 10px;
    right: 10px;
    z-index: 1000;
    padding: 6px 10px;
    font-size: 13px;
    border-radius: 999px;
    border: 1px solid #333;
    background: rgba(20, 20, 24, 0.9);
    color: #e1e1e7;
    cursor: pointer;
    backdrop-filter: blur(6px);
  }

  body.theme-light #themeToggle {
    background: rgba(245, 245, 248, 0.9);
    color: #111;
    border-color: #ccc;
  }
</style>

</head>
<body>
  <button id="themeToggle">ðŸŒ™ Ð¢ÐµÐ¼Ð½Ð° Ñ‚ÐµÐ¼Ð°</button>
  <div id="map"></div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>

const map = L.map("map").setView([49,31],6);
L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

const ICONS = {
    x101: "models/x101.png",
    shahed: "models/shahed.png",
    iskander: "models/iskander.png",
    kalibr: "models/kalibr.png"
};

// Ð†ÐÐ”Ð˜Ð’Ð†Ð”Ð£ÐÐ›Ð¬ÐÐ† OFFSET
const OFFSET = {
    x101: -45,       // Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð°
    shahed: 0,   // Ð¿Ð¾Ð²ÐµÑ€Ð½ÑƒÑ‚Ð¸ Ð· â†‘ Ð½Ð° â†’
    iskander: 0, // Ð¿Ð¾Ð²ÐµÑ€Ð½ÑƒÑ‚Ð¸ Ð· â†‘ Ð½Ð° â†’
    kalibr: 0    // ÐŸÐžÐ¢Ð Ð†Ð‘ÐÐž ÐŸÐ†Ð¡Ð›Ð¯ Ð¢ÐžÐ“Ðž Ð¯Ðš Ð¢Ð˜ ÐšÐ˜ÐÐ•Ð¨ PNG
};

function createMarker(lat, lon, url){
    const div = document.createElement("div");
    div.style.width="60px";
    div.style.height="60px";

    const img=document.createElement("img");
    img.src=url;
    img.style.width="100%";
    img.style.height="100%";
    img.style.transformOrigin="center";

    div.appendChild(img);

    const icon=L.divIcon({className:"",html:div,iconSize:[60,60],iconAnchor:[30,30]});

    const m=L.marker([lat,lon],{icon});
    m._img = img;
    return m;
}

const markers = new Map();

function update(list){
    const exist=new Set();

    for(const t of list){
        exist.add(t.id);

        let m = markers.get(t.id);
        if (!m){
            m = createMarker(t.lat,t.lon,ICONS[t.type]);
            m.addTo(map);
            markers.set(t.id,m);
        } else {
            m.setLatLng([t.lat,t.lon]);
        }

        // ÐŸÐ ÐÐ’Ð˜Ð›Ð¬ÐÐ ÐœÐÐ¢Ð•ÐœÐÐ¢Ð˜ÐšÐ
        let angle = Math.atan2(t.dy, t.dx) * 180 / Math.PI;
        angle = 90 - angle + (OFFSET[t.type] || 0);

        m._img.style.transform = `rotate(${angle}deg)`;
    }

    markers.forEach((m,id)=>{
        if (!exist.has(id)){
            map.removeLayer(m);
            markers.delete(id);
        }
    });
}

const ws = new WebSocket(`wss://${location.host}`);
ws.onmessage = e =>{
    const d = JSON.parse(e.data);
    if (d.type==="state") update(d.targets);
};
    
const THEME_KEY = "airmon_theme";
  const themeBtn = document.getElementById("themeToggle");

  function applyTheme(theme) {
    document.body.classList.remove("theme-dark", "theme-light");
    document.body.classList.add(theme);

    if (theme === "theme-dark") {
      themeBtn.textContent = "â˜€ï¸ Ð¡Ð²Ñ–Ñ‚Ð»Ð° Ñ‚ÐµÐ¼Ð°";
    } else {
      themeBtn.textContent = "ðŸŒ™ Ð¢ÐµÐ¼Ð½Ð° Ñ‚ÐµÐ¼Ð°";
    }

    try {
      localStorage.setItem(THEME_KEY, theme);
    } catch (e) {}
  }

  // ÑÑ‚Ð°Ñ€Ñ‚Ð¾Ð²Ð° Ñ‚ÐµÐ¼Ð°
  (function initTheme() {
    let saved = null;
    try {
      saved = localStorage.getItem(THEME_KEY);
    } catch (e) {}

    if (saved !== "theme-dark" && saved !== "theme-light") {
      saved = "theme-dark"; // Ð´ÐµÑ„Ð¾Ð»Ñ‚
    }
    applyTheme(saved);
  })();

  themeBtn.addEventListener("click", () => {
    const current = document.body.classList.contains("theme-dark")
      ? "theme-dark"
      : "theme-light";
    const next = current === "theme-dark" ? "theme-light" : "theme-dark";
    applyTheme(next);
  });
</script>

</body>
</html>

